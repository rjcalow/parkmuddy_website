<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Is Clumber Park muddy?</title>
  <meta name="description" content="A simple, modern mud estimate for Clumber Park based on recent rainfall and short-term forecast." />
  <meta name="theme-color" content="#0b0d12" />

  <!-- Minimal social -->
  <meta property="og:title" content="Is Clumber Park muddy?" />
  <meta property="og:description" content="A simple mud estimate based on recent rainfall + forecast." />
  <meta property="og:type" content="website" />

  <style>
    /* ---------------- Theme tokens ---------------- */
    :root{
      --bg:#f7f7fb;
      --text:#0b0d12;
      --muted:#667085;
      --stroke:rgba(0,0,0,0.12);
      --card:rgba(255,255,255,0.78);
      --shadow:0 18px 44px rgba(0,0,0,0.10);
      --glass: blur(10px);

      --good:#16a34a;
      --soft:#f59e0b;
      --mud:#fb923c;
      --bad:#ef4444;

      --header-h:56px;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0d12;
        --text:#f2f4f8;
        --muted:#aab3c2;
        --stroke:rgba(255,255,255,0.14);
        --card:rgba(18,22,34,0.78);
        --shadow:0 22px 60px rgba(0,0,0,0.55);
      }
    }
    html[data-theme="light"]{ color-scheme: light; }
    html[data-theme="dark"]{ color-scheme: dark; }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      overflow:hidden;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    a{ color:inherit; text-decoration:underline; text-underline-offset:3px; }

    /* ---------------- Top bar ---------------- */
    .topbar{
      position:fixed; top:0; left:0; right:0;
      z-index:50;
      border-bottom:1px solid var(--stroke);
      background: color-mix(in srgb, var(--bg) 82%, transparent);
      backdrop-filter: var(--glass);
    }
    .topbarInner{
      width:min(900px, 100%);
      margin:0 auto;
      padding:12px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:950;
      letter-spacing:-0.02em;
      white-space:nowrap;
    }
    .dot{
      width:9px; height:9px; border-radius:50%;
      background:linear-gradient(135deg,var(--good),var(--soft),var(--bad));
    }
    .btn{
      border:1px solid var(--stroke);
      background:transparent;
      color:var(--text);
      border-radius:999px;
      padding:8px 12px;
      font-weight:850;
      font-size:13px;
      cursor:pointer;
    }
    .btn:active{ transform:translateY(1px); }

    /* ---------------- Single-page layout ---------------- */
    main{
      height:100vh;
      padding-top:var(--header-h);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .wrap{
      width:min(900px, 100%);
      margin:0 auto;
      padding:16px;
      display:grid;
      gap:12px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:24px;
      padding:16px;
      box-shadow:var(--shadow);
      backdrop-filter: var(--glass);
    }

    .row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .muted{ color:var(--muted); }
    .tiny{ font-size:12px; }
    h1{
      margin:0;
      font-size:22px;
      font-weight:950;
      letter-spacing:-0.02em;
    }

    /* ---------------- Hero "mud postcard" ---------------- */
    .hero{
      position:relative;
      border-radius:26px;
      border:1px solid var(--stroke);
      overflow:hidden;
      height:min(62vh, 520px);
      background: color-mix(in srgb, var(--bg) 88%, transparent);
    }

    /* background bands (dry -> soft -> muddy -> very muddy) */
    .band{ position:absolute; left:0; right:0; }
    .band.good{ background: color-mix(in srgb, var(--good) 18%, transparent); }
    .band.soft{ background: color-mix(in srgb, var(--soft) 18%, transparent); }
    .band.mud { background: color-mix(in srgb, var(--mud) 18%, transparent); }
    .band.bad { background: color-mix(in srgb, var(--bad) 18%, transparent); }

    /* main indicator line */
    .line{
      position:absolute; left:0; right:0;
      height:3px;
      background: color-mix(in srgb, var(--text) 85%, transparent);
      box-shadow: 0 12px 30px rgba(0,0,0,0.20);
    }

    /* glow fill under the line */
    .fill{
      position:absolute; left:0; right:0; bottom:0;
      background: color-mix(in srgb, var(--text) 6%, transparent);
    }

    /* label pill */
    .label{
      position:absolute;
      left:14px;
      transform: translateY(-50%);
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: color-mix(in srgb, var(--bg) 76%, transparent);
      backdrop-filter: var(--glass);
      box-shadow: 0 16px 38px rgba(0,0,0,0.16);
      font-size:13px;
      font-weight:950;
      letter-spacing:-0.01em;
      white-space:nowrap;
    }
    .emoji{
      font-size:16px;
      line-height:1;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background:transparent;
      font-size:12px;
      font-weight:850;
      width:fit-content;
    }
    .dotSmall{ width:10px; height:10px; border-radius:50%; display:inline-block; }

    /* stats grid */
    .grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (min-width: 820px){
      .grid{ grid-template-columns:repeat(4, 1fr); }
    }
    .stat{
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:12px;
      background: transparent;
    }
    .num{
      font-size:26px;
      font-weight:950;
      letter-spacing:-0.02em;
      margin-top:4px;
    }
    .err{ color:#b00020; }
  </style>
</head>

<body>
  <header class="topbar">
    <div class="topbarInner">
      <div class="brand"><span class="dot"></span><span>Clumber Park</span></div>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" id="refreshBtn" type="button">Refresh</button>
        <button class="btn" id="themeBtn" type="button">Theme</button>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <!-- HERO HEADER -->
      <div class="card">
        <div class="row">
          <div>
            <h1>Is it muddy?</h1>
            <div class="muted tiny">Best estimate for Clumber Park based on rainfall + short-term forecast.</div>
          </div>
          <div class="muted tiny" id="updatedText">Updated: —</div>
        </div>
      </div>

      <!-- HERO GRAPHIC -->
      <div class="card" style="padding:12px;">
        <div class="hero" aria-label="Mud estimate graphic">
          <!-- bands (set by JS) -->
          <div class="band good" id="bandGood"></div>
          <div class="band soft" id="bandSoft"></div>
          <div class="band mud"  id="bandMud"></div>
          <div class="band bad"  id="bandBad"></div>

          <div class="fill" id="fill"></div>
          <div class="line" id="line"></div>

          <div class="label" id="label">
            <span class="emoji" id="emoji">—</span>
            <span id="statusText">Loading…</span>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center;">
          <div class="tag"><span class="dotSmall" id="statusDot"></span><span id="guidance">—</span></div>
          <div class="muted tiny" id="cacheText">—</div>
        </div>

        <div id="error" class="muted tiny err" style="margin-top:10px; min-height:16px;"></div>
      </div>

      <!-- STATS -->
      <div class="card">
        <div class="row">
          <div>
            <div style="font-weight:950;">Rainfall</div>
            <div class="muted tiny">These numbers drive the mud estimate.</div>
          </div>
          <div class="muted tiny">mm</div>
        </div>

        <div class="grid">
          <div class="stat">
            <div class="muted tiny">Last 24h</div>
            <div class="num" id="rain24">—</div>
          </div>
          <div class="stat">
            <div class="muted tiny">Last 72h</div>
            <div class="num" id="rain72">—</div>
          </div>
          <div class="stat">
            <div class="muted tiny">Next 12h</div>
            <div class="num" id="rainNext12">—</div>
          </div>
          <div class="stat">
            <div class="muted tiny">Next 24h</div>
            <div class="num" id="rainNext24">—</div>
          </div>
        </div>

        <p class="muted tiny" style="margin:12px 0 0 0; line-height:1.55;">
          Not an official report. Conditions vary by route (main paths vs woodland). If you’re unsure, check the official park info too.
        </p>
      </div>

      <!-- FOOTER -->
      <div class="card">
        <div class="row">
          <div class="muted tiny">
            Data from Open-Meteo via your cached Worker endpoint.
          </div>
          <div class="muted tiny">
            <a href="#" id="apiLink">API</a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // Point this at your worker route
    // e.g. https://clumbermud.co.uk/api/clumber
    const API_URL = "/api/clumber";

    // UI refs
    const el = {
      updatedText: document.getElementById("updatedText"),
      cacheText: document.getElementById("cacheText"),
      error: document.getElementById("error"),
      refreshBtn: document.getElementById("refreshBtn"),
      apiLink: document.getElementById("apiLink"),

      // hero
      line: document.getElementById("line"),
      fill: document.getElementById("fill"),
      label: document.getElementById("label"),
      emoji: document.getElementById("emoji"),
      statusText: document.getElementById("statusText"),
      statusDot: document.getElementById("statusDot"),
      guidance: document.getElementById("guidance"),

      // bands
      bandGood: document.getElementById("bandGood"),
      bandSoft: document.getElementById("bandSoft"),
      bandMud: document.getElementById("bandMud"),
      bandBad: document.getElementById("bandBad"),

      // stats
      rain24: document.getElementById("rain24"),
      rain72: document.getElementById("rain72"),
      rainNext12: document.getElementById("rainNext12"),
      rainNext24: document.getElementById("rainNext24"),
    };

    el.apiLink.href = API_URL;

    // Theme toggle
    (function(){
      const root = document.documentElement;
      const metaTheme = document.querySelector('meta[name="theme-color"]');
      const saved = localStorage.getItem("clumber_theme");
      if (saved === "light" || saved === "dark") root.dataset.theme = saved;
      if (metaTheme) metaTheme.setAttribute("content", root.dataset.theme === "dark" ? "#0b0d12" : "#f7f7fb");

      document.getElementById("themeBtn").addEventListener("click", () => {
        const cur = root.dataset.theme || "";
        const next = (cur === "dark") ? "light" : "dark";
        root.dataset.theme = next;
        localStorage.setItem("clumber_theme", next);
        if (metaTheme) metaTheme.setAttribute("content", next === "dark" ? "#0b0d12" : "#f7f7fb");
      });
    })();

    // Band layout for mudIndex (0..100)
    // 0-20 dry, 21-45 soft, 46-70 muddy, 71-100 very muddy
    function initBands(){
      const p = (n) => n + "%";
      el.bandGood.style.bottom = p(0);  el.bandGood.style.height = p(20);
      el.bandSoft.style.bottom = p(20); el.bandSoft.style.height = p(25); // 20->45
      el.bandMud.style.bottom  = p(45); el.bandMud.style.height  = p(25); // 45->70
      el.bandBad.style.bottom  = p(70); el.bandBad.style.height  = p(30); // 70->100
    }

    function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

    // Convert mud index (0..100) into a vertical % position (0 bottom, 100 top)
    function setIndicator(index){
      const pct = clamp(index, 0, 100);

      // line sits at that height
      el.line.style.bottom = pct + "%";

      // fill is below the line
      el.fill.style.height = pct + "%";

      // label follows the line
      el.label.style.bottom = pct + "%";
    }

    function fmt(n){
      if (!Number.isFinite(n)) return "—";
      return n.toFixed(1);
    }

    function colorForStatus(status){
      switch(status){
        case "dry": return "var(--good)";
        case "soft": return "var(--soft)";
        case "muddy": return "var(--mud)";
        case "very_muddy": return "var(--bad)";
        default: return "transparent";
      }
    }

    function safeTime(iso){
      if (!iso) return "—";
      try { return new Date(iso).toLocaleString(); } catch { return iso; }
    }

    async function load(){
      el.error.textContent = "";
      el.statusText.textContent = "Loading…";
      el.guidance.textContent = "—";

      el.refreshBtn.disabled = true;
      el.refreshBtn.textContent = "Refreshing…";

      try{
        const res = await fetch(API_URL, { headers: { "Accept":"application/json" }});
        if (!res.ok) throw new Error("API HTTP " + res.status);

        const data = await res.json();
        if (!data?.ok) throw new Error(data?.error || "API returned ok=false");

        // Stats
        el.rain24.textContent     = fmt(data?.totals?.rain_24h_mm);
        el.rain72.textContent     = fmt(data?.totals?.rain_72h_mm);
        el.rainNext12.textContent = fmt(data?.totals?.rain_next_12h_mm);
        el.rainNext24.textContent = fmt(data?.totals?.rain_next_24h_mm);

        // Hero
        const idx = Number(data?.mud?.index_0_100);
        setIndicator(Number.isFinite(idx) ? idx : 0);

        const status = data?.mud?.status || "unknown";
        const label  = data?.mud?.label || "Unknown";
        const emoji  = data?.mud?.emoji || "•";
        const guidance = data?.mud?.guidance || "";

        el.emoji.textContent = emoji;
        el.statusText.textContent = label;
        el.guidance.textContent = guidance;
        el.statusDot.style.background = colorForStatus(status);

        // Updated + cache
        el.updatedText.textContent = "Updated: " + safeTime(data?.updatedAt);
        const ttl = data?.cache?.ttlSeconds;
        el.cacheText.textContent = Number.isFinite(ttl) ? `Cache: ${Math.round(ttl/60)} min` : "";

      }catch(e){
        console.error(e);
        el.error.textContent = "Couldn’t load data. " + (e?.message || "Unknown error");
        el.statusText.textContent = "Unavailable";
        el.statusDot.style.background = "transparent";
      }finally{
        el.refreshBtn.disabled = false;
        el.refreshBtn.textContent = "Refresh";
      }
    }

    initBands();
    load();
    el.refreshBtn.addEventListener("click", load);
  </script>
</body>
</html>

